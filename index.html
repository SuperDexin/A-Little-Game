<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Chromle</title>
	<script language="JavaScript" src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
	<style>
		body{
			margin: 0 auto;
			width: 90%;
		}

		div{
			width: 100%;
			font-size: 200%;
		}

		button{
			font-size: 200%;
		}

		@media (orientation: landscape) {
			button{
				font-size: 100%;
			}
		}
	</style>

	<script>
		"use strict";
		var colors = ['红', '绿', '黄', '蓝', '紫', '橙','棕','黑','白'];

		var example_question = ["红", "黄", "红", "绿", "绿", "蓝", "橙", "绿", "白"];
        var example_answer = ["黄", "黄", "蓝", "绿", "紫", "绿", "红", "绿", "紫"];

		var question = new Array(9);
		var answers = new Array(9);

		var nownum = 0;
		var round = 0;

		var answers_bool = true;

		var if_success = false;

		var char_color_bool = false;

        var color_quantity = 5;

        var hash_used = false;

        var is_shared = false;

		function choose(ID) {
			if (nownum >= 0 && nownum < color_quantity && !if_success) {
				answers[nownum] = Number(ID);
				nownum += 1;
				let content = (round+1) + ": ";
				for (let i=0; i<nownum; i++) {
					content = content+" "+colors[answers[i]];
				}
				document.getElementById("answer_region").innerHTML=content;
			}
		}

		function del() {
			if (nownum > 0 && nownum <= color_quantity) {
				nownum -= 1;
				let content = (round+1) + ": ";
				for (let i=0; i<nownum; i++) {
					content = content+" "+colors[answers[i]];
				}
				document.getElementById("answer_region").innerHTML=content;
			}
		}

		function submit() {
			if (nownum === color_quantity) {
				show();
			}
		}

		function show() {
			round++;
			let content1 = round + ": ";
			for (let i=0; i<color_quantity; i++) {
				content1 = content1+" "+colors[answers[i]];
			}
			const [location_num, num_num] = match();
			let content2 = "" + location_num + "个位置颜色正确 " + num_num + "种颜色数量正确";

			let Content1 = document.createTextNode(content1);
			let Content2 = document.createTextNode(content2);

			document.getElementById("answer").appendChild(Content1);
			document.getElementById("answer").appendChild(document.createElement("br"));
			document.getElementById("answer").appendChild(Content2);
			document.getElementById("answer").appendChild(document.createElement("br"));

			let content3;
			let Content3;
			if (location_num === color_quantity) {
				content3 = "Congratulations!"
				Content3 = document.createTextNode(content3);
				let para = document.createElement("p");
				para.setAttribute("style","color: red; font-size: 210%;");
				para.appendChild(Content3);
				document.getElementById("answer").appendChild(para);
				let num = 0;
				for (let i=0; i<color_quantity; i++) {
					num += question[i];
					num *= 10;
				}
				num += color_quantity;

				let num_16 = num.toString(16)

				const base_url = location.href.replace(location.hash, "");
				document.getElementById("answer_region").innerHTML
					= "如果你想和好友分享本局的问题，可以复制以下链接："
					+ `<a href="${base_url}#${num_16}">${base_url}#${num_16}</a>`;
				if_success = true;
			}
			else{
				document.getElementById("answer_region").innerHTML=(round+1) + ":";
			}

			nownum = 0;
		}

		function refresh() {
			try {
				if (hash_used) {
					throw 1;
				} else {
					hash_used = true;
					if (location.hash === "") {
						throw 1;
					}
					let num16_string = location.hash.slice(1);
					let num = parseInt(num16_string, 16);
					let num_string = num.toString();

					if (Number.isNaN(num)) {
						throw 1;
					}

					color_quantity = parseInt(num_string.charAt(num_string.length - 1));
					let question_from_hash = [0,0,0,0,0,0,0,0,0];
					for (let i = 1; i<num_string.length; i++) {
						question_from_hash[color_quantity-i] = parseInt(num_string.charAt(num_string.length-1-i));
						if (question_from_hash[0] >= color_quantity) {
							color_quantity = 5;
							throw 1;
						}
					}

					document.getElementById("head").innerHTML="Chromle 有人想让你试试这道题";
					question = question_from_hash;
					is_shared = true;
				}
			}
			catch (e) {
				for (let i=0; i<color_quantity; i++) {
					question[i] = Math.floor((Math.random() * color_quantity));	
				}
				document.getElementById("head").innerHTML="Chromle";
				is_shared = false;
			}
			document.getElementById("answer").innerHTML="";
			document.getElementById("answer_region").innerHTML="1:";
			round = 0;
			nownum = 0;
			answers_bool = true;
			if_success = false;
			document.getElementById("check_answer").innerHTML="显示答案";
			change_button_num();
			change_rules();
		}

		function match() {
			let location_num = 0;
			let answers_color_num = count(answers);
			let question_color_num = count(question);
			let num_num = 0;
			for (let i=0; i<color_quantity; i++) {
				if (question[i] === answers[i]) {
					location_num ++;
				}
				if ((answers_color_num[i] === question_color_num[i]) && (answers_color_num[i] !== 0)) {
					num_num++;
				}
			}
			return [location_num, num_num];
		}

		function count(array) {
			let color_num = [0,0,0,0,0,0,0,0,0];
			for (let i=0; i<color_quantity; i++) {
				color_num[array[i]] ++;
			}
			return color_num;
		}

		function show_answer() {
			let content = "";
			let button_content;
			if (!answers_bool) {
				button_content = "显示答案";
				if(is_shared){
					content = "Chromle 有人想让你试试这道题";
				}
				else{
					content = "Chromle";
				}
			}
			if (answers_bool) {
				for (let i=0; i<color_quantity; i++) {
					content = content+" "+colors[question[i]];
				}
				button_content = "隐藏答案";
			}
			document.getElementById("head").innerHTML=content;
			document.getElementById("check_answer").innerHTML=button_content;
			answers_bool = !answers_bool;
		}

		function switch_char_color() {
			if (char_color_bool) {
				colors = ['红', '绿', '黄', '蓝', '紫', '橙','棕','黑','白'];
				example_question = ["红", "黄", "红", "绿", "绿", "蓝", "橙", "绿", "白"];
        		example_answer = ["黄", "黄", "蓝", "绿", "紫", "绿", "红", "绿", "紫"];
			}
			else{
				colors = ['🟥', '🟩', '🟨', '🟦', '🟪', '🟧', '🟫', '⬛', '⬜'];
				example_question = ["🟥", "🟨", "🟥", "🟩", "🟩", "🟦", "🟧", "🟩", "⬜"];
        		example_answer = ["🟨", "🟨", "🟦", "🟩", "🟪", "🟩", "🟥", "🟩", "🟪"];
			}
			for (let i = 0; i<color_quantity; i++) {
				document.getElementById(i).innerHTML=colors[i];
			}

			let content = "";
			if (!answers_bool) {
				for (let i=0; i<color_quantity; i++) {
					content = content+" "+colors[question[i]];
				}
				document.getElementById("head").innerHTML=content;
			}
			
			change_rules();
			char_color_bool = !char_color_bool;
		}

        function shift_color_quantity(value){
        	value = parseInt(value);
            color_quantity = value;
            refresh();
        }

        function change_rules(){
        	let i;
        	let example_loc = [0, 0, 0, 1, 2, 2, 2, 2, 3, 3];
        	let example_num = [0, 0, 0, 0, 1, 0, 2, 2, 2, 2];

        	let content1 = "“";
            for(i=0; i < (color_quantity-1); i++){
            	content1 = content1 + colors[i] + "、";
            }
            content1 = content1 + colors[i] + "”";
            document.getElementById("rule1").innerHTML="规则：一共有" + color_quantity + "个位置，每个位置会随机生成" + content1 + color_quantity + "种颜色之一，需要我们去猜出生成的结果是什么。<br>";

            let content2 = "如生成“";
            for(i=0; i < (color_quantity-1); i++){
            	content2 = content2 + example_question[i] + "、";
            }
            content2 = content2 + example_question[i] + "”，猜测“";
            for(i=0; i < (color_quantity-1); i++){
            	content2 = content2 + example_answer[i] + "、";
            }
            content2 = content2 + example_answer[i] + "”，会出现“" + example_loc[color_quantity] + "个位置颜色正确 " + example_num[color_quantity] + "种颜色数量正确”。<br>";
            document.getElementById("rule2").innerHTML=content2;
            document.getElementById("rule3").innerHTML="出现“" + color_quantity + "个位置颜色正确”即算成功。";
        }

        function change_button_num(){
        	$("#buttons").empty();
    		for(let i = 0; i < color_quantity; i++){
         		let button = document.createElement("button");
        		button.innerHTML = colors[i];
        		button.setAttribute("id", "" + i);
        		button.setAttribute("onClick", "choose(this.id)");
        		document.getElementById("buttons").appendChild(button);
    		}
        }

	</script>
</head>

<body>
	<div>
	<h1 id="head"></h1>
	<div style="font-size: 30%">
        <div id="rule1"></div>
		<div>每猜测一次，可得到两条信息：</div>
		<ol style="font-size: 200%">
			<li>有几个位置上出现的颜色是正确的；</li>
			<li>有几个颜色出现的次数是正确的（不包括猜对出现0次的颜色）。</li>
		</ol>
		<div id="rule2"></div>
		<div id="rule3"></div>
	</div>
	<p id="answer"></p>
	<p></p>
	<p id="answer_region">1:</p>
	<p id="buttons">
	</p>
	<p>
		<button onclick="submit()">确定</button>
		<button onclick="del()">删除</button>
		<button onclick="refresh()">换一局</button>
		<button onclick="show_answer()" id="check_answer"></button>
	</p>
    <p>
        <button onclick="switch_char_color()">切换颜色显示方式</button>
    </p>
    <p>选择颜色个数
        <select id="color_num" style="font-size: 100%" onchange="shift_color_quantity(this.value)">
            <option value = "3">3</option>
            <option value = "4">4</option>
            <option value = "5">5</option>
            <option value = "6">6</option>
            <option value = "7">7</option>
            <option value = "8">8</option>
            <option value = "9">9</option>
        </select>
    </p>

	</div>
	<script>
		refresh();
	</script>
</body>
</html>